# 系统健康警示灯 - 使用说明

## 概述

系统健康警示灯是一个直观的系统状态指示器，位于前端页面右上角，实时显示系统健康状态。

## 功能特性

### 1. 三种状态指示

#### 🟢 绿色 - 系统正常

- **含义**: 系统运行正常，无问题
- **显示**: 绿色圆点，柔和呼吸灯效果
- **文字**: "系统正常"

#### 🟡 黄色 - 系统警告

- **含义**: 系统存在警告，需要关注但不影响运行
- **显示**: 黄色圆点，中速闪烁效果
- **文字**: "系统警告"
- **常见原因**:
  - 发现孤儿条件单（已自动修复）
  - 交易所与数据库持仓不一致
  - API 响应异常

#### 🔴 红色 - 系统异常

- **含义**: 系统存在严重问题，需要立即处理
- **显示**: 红色圆点，快速闪烁效果
- **文字**: "系统异常"
- **常见原因**:
  - 存在未解决的不一致状态
  - 数据库连接异常
  - 交易所 API 连接失败
  - 健康检查连续失败

### 2. 详细信息提示

将鼠标悬停在健康警示灯上，可以查看详细的问题描述：

- 问题类型
- 问题数量
- 具体描述

### 3. 自动更新机制

- **更新频率**: 每 30 秒自动轮询一次
- **首次加载**: 页面加载时立即检查一次
- **失败处理**: 如果无法连接健康检查服务，显示为红色"连接失败"状态

## 技术实现

### 后端 API

**路由**: `GET /api/health`

**返回数据结构**:

```json
{
  "healthy": true,
  "issues": [],
  "warnings": [],
  "timestamp": "2025-11-12T10:30:00.000Z",
  "details": {
    "orphanOrders": 0,
    "inconsistentStates": 0,
    "positionMismatches": {
      "onlyInExchange": [],
      "onlyInDB": []
    }
  }
}
```

### 健康检查项目

1. **孤儿条件单检查**: 检测有条件单但无持仓的情况，自动清理
2. **不一致状态检查**: 检测未解决的系统不一致状态
3. **持仓一致性检查**: 对比交易所和数据库的持仓数据
4. **数据库连接检查**: 验证数据库连接是否正常
5. **交易所 API 检查**: 验证交易所 API 是否可用

### 前端实现

- **位置**: `/public/index.html` - 导航栏右上角
- **样式**: `/public/monitor-styles.css` - `.health-indicator` 相关样式
- **逻辑**: `/public/monitor-script.js` - `updateHealthStatus()` 方法

## 使用建议

1. **日常监控**: 定期查看健康警示灯状态，确保系统正常运行
2. **异常处理**: 发现红色异常状态时，及时查看详细信息并处理
3. **警告处理**: 黄色警告通常不需要立即处理，但需要关注是否持续出现
4. **邮件告警**: 严重问题会同时触发邮件告警（如果已配置）

## 与现有系统的集成

- 基于 `src/scheduler/healthCheck.ts` 的健康检查服务
- 不影响现有前端页面的其他模块和样式
- 使用独立的 CSS 类名，避免样式冲突
- 遵循现有的绿色科技主题设计风格

## 故障排除

### 警示灯一直显示"检测中..."

- 检查后端服务是否正常运行
- 检查 `/api/health` 接口是否可访问
- 查看浏览器控制台是否有错误信息

### 警示灯显示"连接失败"

- 检查网络连接
- 检查后端服务是否启动
- 检查健康检查服务是否正常工作

### 警示灯一直显示异常

- 查看悬浮提示的详细错误信息
- 检查系统日志和数据库状态
- 运行手动健康检查进行诊断

## 相关文件

- 后端健康检查服务: `src/scheduler/healthCheck.ts`
- API 路由: `src/api/routes.ts`
- 前端页面: `public/index.html`
- 前端样式: `public/monitor-styles.css`
- 前端逻辑: `public/monitor-script.js`
